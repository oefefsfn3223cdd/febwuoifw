"""
Text-to-Speech –º–æ–¥—É–ª—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
"""
import os
import json
from pydoc import text
import pygame
import time
import subprocess
import tempfile


# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è pygame mixer –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–æ–≤
pygame.mixer.init()

# –ú–∞–ø–ø–∏–Ω–≥ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ—Ä–∞–∑ –Ω–∞ –Ω–æ–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
VOICE_MAP = {
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    "–ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?": "001",
    "–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ! –ù–∞–¥–µ—é—Å—å, –¥–µ–Ω—å –±—É–¥–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ã–º.": "002",
    "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –Ø –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º.": "003",
    "–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä! –ö–∞–∫ –ø—Ä–æ—à—ë–ª –¥–µ–Ω—å?": "004",
    "–°–ø–æ–∫–æ–π–Ω–æ–π –Ω–æ—á–∏! –ü—Ä–∏—è—Ç–Ω—ã—Ö —Å–Ω–æ–≤.": "005",
    "–ü—Ä–∏–≤–µ—Ç! –Ø –ú–æ–Ω–æ, –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º.": "006",
    
    # Wake word
    "–î–∞, —Å—ç—Ä?": "007",
    "–°–ª—É—à–∞—é –≤–∞—Å": "008",
    "–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?": "009",
    "–ö –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º": "010",
    
    # –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏
    "–í—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞! –û–±—Ä–∞—â–∞–π—Ç–µ—Å—å.": "011",
    "–°—Ç–∞—Ä–∞—é—Å—å –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º!": "012",
    "–î–æ –≤—Å—Ç—Ä–µ—á–∏! –ë—É–¥—É –∂–¥–∞—Ç—å.": "013",
    
    # –û —Å–µ–±–µ
    "–Ø –ú–æ–Ω–æ, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –°–æ–∑–¥–∞–Ω —á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å –≤–∞–º.": "014",
    "–Ø —É–º–µ—é: –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Å–∞–π—Ç—ã, —É–ø—Ä–∞–≤–ª—è—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å—é –∏ —è—Ä–∫–æ—Å—Ç—å—é, –≥–æ–≤–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è –∏ –¥–∞—Ç—É, —Å—á–∏—Ç–∞—Ç—å, –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏, –∏—Å–∫–∞—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ. –ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ –Ω—É–∂–Ω–æ!": "015",
    "–û—Ç–ª–∏—á–Ω–æ! –í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ. –ê —É –≤–∞—Å –∫–∞–∫?": "016",
    
    # –®—É—Ç–∫–∏
    "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç —Å—Ç–∞–≤–∏—Ç –Ω–∞ —Ç—É–º–±–æ—á–∫—É –¥–≤–∞ —Å—Ç–∞–∫–∞–Ω–∞. –û–¥–∏–Ω —Å –≤–æ–¥–æ–π ‚Äî –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—Ç –ø–∏—Ç—å. –í—Ç–æ—Ä–æ–π –ø—É—Å—Ç–æ–π ‚Äî –µ—Å–ª–∏ –Ω–µ –∑–∞—Ö–æ—á–µ—Ç.": "017",
    "–ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø—É—Ç–∞—é—Ç –•—ç–ª–ª–æ—É–∏–Ω –∏ –†–æ–∂–¥–µ—Å—Ç–≤–æ? –ü–æ—Ç–æ–º—É —á—Ç–æ 31 OCT —Ä–∞–≤–Ω–æ 25 DEC.": "018",
    "–ñ–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞ –ø—Ä–æ—Å–∏—Ç: –°—Ö–æ–¥–∏ –≤ –º–∞–≥–∞–∑–∏–Ω, –∫—É–ø–∏ –±–∞—Ç–æ–Ω —Ö–ª–µ–±–∞. –ï—Å–ª–∏ –±—É–¥—É—Ç —è–π—Ü–∞ ‚Äî –≤–æ–∑—å–º–∏ –¥–µ—Å—è—Ç–æ–∫. –ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç –≤–µ—Ä–Ω—É–ª—Å—è —Å –¥–µ—Å—è—Ç—å—é –±–∞—Ç–æ–Ω–∞–º–∏.": "019",
    
    # –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
    "–ù–µ —Å–º–æ–≥ –≤—ã—á–∏—Å–ª–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞–∑–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É.": "020",
    
    # –ü–æ–≥–æ–¥–∞
    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.": "021",
    
    # –ó–∞–º–µ—Ç–∫–∏
    "–ß—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–ø–æ–º–Ω–∏—Ç—å?": "022",
    "–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.": "023",
    
    # –ì—Ä–æ–º–∫–æ—Å—Ç—å
    "–ì—Ä–æ–º–∫–æ—Å—Ç—å —É–≤–µ–ª–∏—á–µ–Ω–∞": "024",
    "–ì—Ä–æ–º–∫–æ—Å—Ç—å —É–º–µ–Ω—å—à–µ–Ω–∞": "025",
    "–ì—Ä–æ–º–∫–æ—Å—Ç—å –Ω–∞ –º–∞–∫—Å–∏–º—É–º": "026",
    "–ó–≤—É–∫ –≤—ã–∫–ª—é—á–µ–Ω": "027",
    "–ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω": "028",
    "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å": "029",
    
    # –Ø—Ä–∫–æ—Å—Ç—å
    "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å —è—Ä–∫–æ—Å—Ç—å": "030",
    
    # –°–∏—Å—Ç–µ–º–∞
    "–í—ã–∫–ª—é—á–∞—é –∫–æ–º–ø—å—é—Ç–µ—Ä —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥.": "031",
    "–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é —Å–∏—Å—Ç–µ–º—É.": "032",
    "–ü–µ—Ä–µ—Ö–æ–∂—É –≤ —Å–ø—è—â–∏–π —Ä–µ–∂–∏–º.": "033",
    "–ë–ª–æ–∫–∏—Ä—É—é –∫–æ–º–ø—å—é—Ç–µ—Ä.": "034",
    "–í—ã—Ö–æ–∂—É –∏–∑ —Å–∏—Å—Ç–µ–º—ã.": "035",
    
    # –ë–∞—Ç–∞—Ä–µ—è
    "–ë–∞—Ç–∞—Ä–µ—è –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –≤–µ—Ä–æ—è—Ç–Ω–æ —ç—Ç–æ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä": "036",
    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞—Ç–∞—Ä–µ—é": "037",

    # –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    "–û—Ç–∫—Ä—ã–≤–∞—é YouTube": "038",
    "–û—Ç–∫—Ä—ã–≤–∞—é ChatGPT": "039",
    "–û—Ç–∫—Ä—ã–≤–∞—é Google": "040",
    "–û—Ç–∫—Ä—ã–≤–∞—é –±—Ä–∞—É–∑–µ—Ä": "041",
    "–û—Ç–∫—Ä—ã–≤–∞—é –¥–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á": "042",
    "–û—Ç–∫—Ä—ã–≤–∞—é –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è": "043",
    "–û—Ç–∫—Ä—ã–≤–∞—é –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Windows": "044",
    "–ó–∞–ø—É—Å–∫–∞—é –¥–∏—Å–∫–æ—Ä–¥": "045",
    "–ó–∞–ø—É—Å–∫–∞—é —Å—Ç–∏–º": "046",
    "–ó–∞–ø—É—Å–∫–∞—é —Å–ø–æ—Ç–∏—Ñ–∞–π": "047",
    "–ó–∞–ø—É—Å–∫–∞—é —Ç–µ–ª–µ–≥—Ä–∞–º": "048",
    "–ó–∞–ø—É—Å–∫–∞—é –±–ª–æ–∫–Ω–æ—Ç": "049",
    "–ó–∞–ø—É—Å–∫–∞—é –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä": "050",
    "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.": "051",
    "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ": "052",
    
    # –ú–µ–¥–∏–∞
    "–°–∫—Ä–∏–Ω—à–æ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω": "053",
    "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç": "054",
    "–ì–æ—Ç–æ–≤–æ": "055",
    "–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–∂—É": "056",
    "–°–ª–µ–¥—É—é—â–∏–π —Ç—Ä–µ–∫": "057",
    "–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ç—Ä–µ–∫": "058",
    "–û—Ç–∫—Ä—ã–≤–∞—é –ø—Ä–æ–≤–æ–¥–Ω–∏–∫": "059",
    "–û—Ç–∫—Ä—ã–≤–∞—é —Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª": "060",
    "–û—Ç–∫—Ä—ã–≤–∞—é –∑–∞–≥—Ä—É–∑–∫–∏": "061",
    "–û—Ç–∫—Ä—ã–≤–∞—é –¥–æ–∫—É–º–µ–Ω—Ç—ã": "062",
    "–†–∞–∑–≤–µ—Ä–Ω—É–ª": "063",
    "–ó–∞–∫—Ä—ã–≤–∞—é": "064",
    "–ü–µ—Ä–µ–∫–ª—é—á–∞—é": "065",
    "–°–≤–µ—Ä–Ω—É–ª": "066",
    
    # –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
    "–û—Ç–∫—Ä—ã–≤–∞—é –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫": "067",
    "–û—Ç–∫—Ä—ã–≤–∞—é –≤–∫–æ–Ω—Ç–∞–∫—Ç–µ": "068",
    "–û—Ç–∫—Ä—ã–≤–∞—é –∏–Ω—Å—Ç–∞–≥—Ä–∞–º": "069",
    "–û—Ç–∫—Ä—ã–≤–∞—é —Ç–≤–∏—Ç—Ç–µ—Ä": "070",
    "–û—Ç–∫—Ä—ã–≤–∞—é —Ñ–µ–π—Å–±—É–∫": "071",
    "–û—Ç–∫—Ä—ã–≤–∞—é –≥–∏—Ç—Ö–∞–±": "072",
    "–û—Ç–∫—Ä—ã–≤–∞—é —Ç–≤–∏—á": "073",
    "–û—Ç–∫—Ä—ã–≤–∞—é –Ω–æ–≤–æ—Å—Ç–∏": "074",
    "–û—Ç–∫—Ä—ã–≤–∞—é –ø–æ—á—Ç—É": "075",
    "–û—Ç–∫—Ä—ã–≤–∞—é —è–Ω–¥–µ–∫—Å": "076",
    "–û—Ç–∫—Ä—ã–≤–∞—é –∫–∏–Ω–æ–ø–æ–∏—Å–∫": "077",
    "–û—Ç–∫—Ä—ã–≤–∞—é –≤–∏–∫–∏–ø–µ–¥–∏—é": "078",
    "–û—Ç–∫—Ä—ã–≤–∞—é –Ω–µ—Ç—Ñ–ª–∏–∫—Å": "079",
    
    # –í–≤–æ–¥
    "–ù–∞–ø–µ—á–∞—Ç–∞–ª": "080",
    "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ": "081",
    "–í—Å—Ç–∞–≤–ª–µ–Ω–æ": "082",
    "–í—ã—Ä–µ–∑–∞–Ω–æ": "083",
    "–í—ã–¥–µ–ª–µ–Ω–æ": "084",
    "–û—Ç–º–µ–Ω–µ–Ω–æ": "085",
    "–ü–æ–≤—Ç–æ—Ä–µ–Ω–æ": "086",
    "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ": "087",
    "–§–∞–π–ª —É–¥–∞–ª—ë–Ω": "088",
    "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω": "089",
    "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª": "090",
    "–û—Ç–∫—Ä—ã–≤–∞—é": "091",
    "–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞": "092",
    
    # –¢–∞–π–º–µ—Ä
    "–¢–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª! –í—Ä–µ–º—è –≤—ã—à–ª–æ.": "093",
    "–¢–∞–π–º–µ—Ä –æ—Ç–º–µ–Ω—ë–Ω": "094",
    "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤": "095",
    "–ù–µ –ø–æ–Ω—è–ª –≤—Ä–µ–º—è. –°–∫–∞–∂–∏—Ç–µ –Ω–∞–ø—Ä–∏–º–µ—Ä: —Ç–∞–π–º–µ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç": "096",
    
    # –û—à–∏–±–∫–∏
    "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–∫–∞–∑–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É.": "097",
    "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã.": "098",
}

# –ß–∏—Å–ª–∞
NUMBERS = {
    0: "100", 1: "101", 2: "102", 3: "103", 4: "104",
    5: "105", 6: "106", 7: "107", 8: "108", 9: "109",
    10: "110", 11: "111", 12: "112", 13: "113", 14: "114",
    15: "115", 16: "116", 17: "117", 18: "118", 19: "119",
    20: "120", 30: "121", 40: "122", 50: "123", 60: "124",
    70: "125", 80: "126", 90: "127", 100: "128"
}

# –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
DAYS = {
    "–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫": "160", "–≤—Ç–æ—Ä–Ω–∏–∫": "161", "—Å—Ä–µ–¥–∞": "162",
    "—á–µ—Ç–≤–µ—Ä–≥": "163", "–ø—è—Ç–Ω–∏—Ü–∞": "164", "—Å—É–±–±–æ—Ç–∞": "165", "–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ": "166"
}

# –ú–µ—Å—è—Ü—ã
MONTHS = {
    "—è–Ω–≤–∞—Ä—è": "170", "—Ñ–µ–≤—Ä–∞–ª—è": "171", "–º–∞—Ä—Ç–∞": "172", "–∞–ø—Ä–µ–ª—è": "173",
    "–º–∞—è": "174", "–∏—é–Ω—è": "175", "–∏—é–ª—è": "176", "–∞–≤–≥—É—Å—Ç–∞": "177",
    "—Å–µ–Ω—Ç—è–±—Ä—è": "178", "–æ–∫—Ç—è–±—Ä—è": "179", "–Ω–æ—è–±—Ä—è": "180", "–¥–µ–∫–∞–±—Ä—è": "181"
}

# –°–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞
WORDS = {
    "–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤": "130",
    "–º–∏–Ω—É—Ç": "131",
    "–º–∏–Ω—É—Ç—ã": "132",
    "–º–∏–Ω—É—Ç—É": "133",
    "—Å–µ–∫—É–Ω–¥": "134",
    "—Å–µ–∫—É–Ω–¥—ã": "135",
    "—á–∞—Å": "136",
    "—á–∞—Å–∞": "137",
    "—á–∞—Å–æ–≤": "138",
    "–ì—Ä–æ–º–∫–æ—Å—Ç—å": "139",
    "–Ø—Ä–∫–æ—Å—Ç—å": "140",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç": "141",
    "–¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞": "142",
    "–î–æ —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å": "143",
    "–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏": "144",
    "—Ä–∞–±–æ—Ç–∞—é –æ—Ç –±–∞—Ç–∞—Ä–µ–∏": "145",
    "—Ä–∞–±–æ—Ç–∞—é –Ω–∞ –∑–∞—Ä—è–¥–∫–µ": "146",
    "–ó–∞–ø–æ–º–Ω–∏–ª": "147",
    "–£ –≤–∞—Å": "148",
    "–∑–∞–º–µ—Ç–æ–∫": "149",
    "–ü–æ—Å–ª–µ–¥–Ω—è—è": "150",
    "–°–µ–π—á–∞—Å": "151",
    "–°–µ–≥–æ–¥–Ω—è": "152",
    "–ü–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ": "153",
    "–ò—â—É": "154",
    "–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ": "155",
}


def get_base_path():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤"""
    import sys
    if getattr(sys, 'frozen', False):
        return sys._MEIPASS
    return os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


class TextToSpeech:
    def __init__(self, config_path="config.json"):
        self.use_piper = True
        self.base_path = get_base_path()
        self.voice_path = os.path.join(self.base_path, "sounds", "voice")
        self.gui = None
        self.use_custom_voice = True
        self.fallback_engine = None
        self.piper_path = os.path.join(self.base_path, "piper", "piper.exe")
        self.voice_model = os.path.join(self.base_path, "voices", "irina.onnx")
        
        self.use_piper = (
            os.path.exists(self.piper_path)
            and os.path.exists(self.voice_model)
        )
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
        if not os.path.exists(self.voice_path) or not os.listdir(self.voice_path):
            print(f"‚ö†Ô∏è –ì–æ–ª–æ—Å–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ {self.voice_path}, –∏—Å–ø–æ–ª—å–∑—É—é —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä")
            self.use_custom_voice = False
            self._init_fallback()
    
    def _init_fallback(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–∞—Å–Ω–æ–≥–æ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞"""
        try:
            import pyttsx3
            self.fallback_engine = pyttsx3.init()
            self.fallback_engine.setProperty('rate', 165)
        except:
            print("‚ö†Ô∏è pyttsx3 –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω")
    
    def _speak_piper(self, text: str):
        try:
            import subprocess
            import tempfile
            import os
            import time

            with tempfile.NamedTemporaryFile(delete=False, suffix=".wav") as f:
                wav_path = f.name

            cmd = [
                self.piper_path,
                "--model", self.voice_model,
                "--text", text,
                "--output_file", wav_path
            ]

            subprocess.run(
                cmd,
                stdout=subprocess.DEVNULL,
                stderr=subprocess.DEVNULL,
                timeout=15
            )

            if not os.path.exists(wav_path) or os.path.getsize(wav_path) < 44:
                raise RuntimeError("Piper did not generate valid WAV")

            sound = pygame.mixer.Sound(wav_path)
            sound.play()
            while pygame.mixer.get_busy():
                time.sleep(0.05)

            os.remove(wav_path)
            return True

        except Exception as e:
            print(f"‚ùå Piper TTS error: {e}")
            return False



    def set_gui(self, gui):
        self.gui = gui
    
    def _play_file(self, file_id):
        """–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∞—É–¥–∏–æ—Ñ–∞–π–ª –ø–æ ID"""
        filepath = os.path.join(self.voice_path, f"{file_id}.wav")
        if os.path.exists(filepath):
            try:
                sound = pygame.mixer.Sound(filepath)
                sound.play()
                # –ñ–¥—ë–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                while pygame.mixer.get_busy():
                    time.sleep(0.1)
                return True
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è {filepath}: {e}")
        return False
    
    def _play_files(self, file_ids):
        """–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"""
        for fid in file_ids:
            self._play_file(fid)
            time.sleep(0.05)  # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏
    
    def _number_to_files(self, num):
        """–ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —á–∏—Å–ª–æ –≤ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è"""
        files = []
        num = int(num)
        
        if num in NUMBERS:
            files.append(NUMBERS[num])
        elif num < 100:
            tens = (num // 10) * 10
            ones = num % 10
            if tens in NUMBERS:
                files.append(NUMBERS[tens])
            if ones > 0 and ones in NUMBERS:
                files.append(NUMBERS[ones])
        elif num == 100:
            files.append(NUMBERS[100])
        else:
            # –î–ª—è —á–∏—Å–µ–ª > 100 –ø—Ä–æ—Å—Ç–æ –æ–∑–≤—É—á–∏–≤–∞–µ–º —Ü–∏—Ñ—Ä—ã
            for digit in str(num):
                if int(digit) in NUMBERS:
                    files.append(NUMBERS[int(digit)])
        
        return files
    
    def speak(self, text):
        """–û–∑–≤—É—á–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç"""
        print(f"üîä Assistant: {text}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GUI
        if self.gui:
            self.gui.signals.jarvis_response.emit(text)
            self.gui.signals.log_message.emit(f"–ú–æ–Ω–æ: {text}")
        
        if not self.use_custom_voice:
            self._speak_fallback(text)
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        if text in VOICE_MAP:
            self._play_file(VOICE_MAP[text])
            return
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏–ª–∏ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –∏–∑ —á–∞—Å—Ç–µ–π
        spoken = self._speak_dynamic(text)
        
        if not spoken:
            if self.use_piper:
                ok = self._speak_piper(text)
            if not ok:
                self._speak_fallback(text)
            else:
                self._speak_fallback(text)

            
    
    def _speak_dynamic(self, text):
        """–ü—ã—Ç–∞–µ—Ç—Å—è —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ñ—Ä–∞–∑—É –∏–∑ —á–∞—Å—Ç–µ–π"""
        
        # –ì—Ä–æ–º–∫–æ—Å—Ç—å X –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        if "–ì—Ä–æ–º–∫–æ—Å—Ç—å" in text and "–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤" in text:
            import re
            match = re.search(r'(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_file("139")  # –ì—Ä–æ–º–∫–æ—Å—Ç—å
                self._play_files(self._number_to_files(num))
                self._play_file("130")  # –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                return True
        
        # –Ø—Ä–∫–æ—Å—Ç—å X –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        if "–Ø—Ä–∫–æ—Å—Ç—å" in text and "–ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤" in text:
            import re
            match = re.search(r'(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_file("140")  # –Ø—Ä–∫–æ—Å—Ç—å
                self._play_files(self._number_to_files(num))
                self._play_file("130")  # –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
                return True
        
        # –†–µ–∑—É–ª—å—Ç–∞—Ç: X
        if "–†–µ–∑—É–ª—å—Ç–∞—Ç:" in text:
            import re
            match = re.search(r'–†–µ–∑—É–ª—å—Ç–∞—Ç:\s*(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_file("141")  # –†–µ–∑—É–ª—å—Ç–∞—Ç
                self._play_files(self._number_to_files(num))
                return True
        
        # –°–µ–π—á–∞—Å X —á–∞—Å–æ–≤ Y –º–∏–Ω—É—Ç
        if "–°–µ–π—á–∞—Å" in text and "—á–∞—Å–æ–≤" in text:
            import re
            match = re.search(r'–°–µ–π—á–∞—Å\s*(\d+)\s*—á–∞—Å–æ–≤\s*(\d+)\s*–º–∏–Ω—É—Ç', text)
            if match:
                hours = int(match.group(1))
                mins = int(match.group(2))
                self._play_file("151")  # –°–µ–π—á–∞—Å
                self._play_files(self._number_to_files(hours))
                self._play_file("138")  # —á–∞—Å–æ–≤
                self._play_files(self._number_to_files(mins))
                self._play_file("131")  # –º–∏–Ω—É—Ç
                return True
        
        # –¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ X –º–∏–Ω—É—Ç
        if "–¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞" in text:
            import re
            self._play_file("142")  # –¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞
            
            # –ò—â–µ–º –º–∏–Ω—É—Ç—ã
            match = re.search(r'(\d+)\s*–º–∏–Ω—É—Ç', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
                self._play_file("131")  # –º–∏–Ω—É—Ç
                return True
            
            # –ò—â–µ–º —Å–µ–∫—É–Ω–¥—ã
            match = re.search(r'(\d+)\s*—Å–µ–∫—É–Ω–¥', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
                self._play_file("134")  # —Å–µ–∫—É–Ω–¥
                return True
        
        # –î–æ —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å
        if "–î–æ —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å" in text:
            import re
            self._play_file("143")  # –î–æ —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–ª–æ—Å—å
            
            match = re.search(r'(\d+)\s*–º–∏–Ω—É—Ç', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
                self._play_file("131")
                return True
            
            match = re.search(r'(\d+)\s*—Å–µ–∫—É–Ω–¥', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
                self._play_file("134")
                return True
        
        # –ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏
        if "–ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏" in text:
            import re
            self._play_file("144")  # –ó–∞—Ä—è–¥ –±–∞—Ç–∞—Ä–µ–∏
            match = re.search(r'(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
                self._play_file("130")  # –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
            
            if "–Ω–∞ –∑–∞—Ä—è–¥–∫–µ" in text:
                self._play_file("146")
            elif "–æ—Ç –±–∞—Ç–∞—Ä–µ–∏" in text:
                self._play_file("145")
            return True
        
        # –ó–∞–ø–æ–º–Ω–∏–ª: X
        if "–ó–∞–ø–æ–º–Ω–∏–ª:" in text:
            self._play_file("147")  # –ó–∞–ø–æ–º–Ω–∏–ª
            return True
        
        # –£ –≤–∞—Å X –∑–∞–º–µ—Ç–æ–∫
        if "–£ –≤–∞—Å" in text and "–∑–∞–º–µ—Ç–æ–∫" in text:
            import re
            self._play_file("148")  # –£ –≤–∞—Å
            match = re.search(r'(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
            self._play_file("149")  # –∑–∞–º–µ—Ç–æ–∫
            return True
        
        # –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å, —á–∏—Å–ª–æ –º–µ—Å—è—Ü –≥–æ–¥
        if "–°–µ–≥–æ–¥–Ω—è" in text:
            self._play_file("152")  # –°–µ–≥–æ–¥–Ω—è
            
            for day, fid in DAYS.items():
                if day in text:
                    self._play_file(fid)
                    break
            
            import re
            match = re.search(r'(\d+)', text)
            if match:
                num = int(match.group(1))
                self._play_files(self._number_to_files(num))
            
            for month, fid in MONTHS.items():
                if month in text:
                    self._play_file(fid)
                    break
            
            if "2024" in text:
                self._play_file("190")
            elif "2025" in text:
                self._play_file("191")
            
            return True
        
        # –ü–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ
        if "–ü–æ–≥–æ–¥–∞ –≤ –≥–æ—Ä–æ–¥–µ" in text:
            self._play_file("153")
            return True
        
        # –ò—â—É X
        if text.startswith("–ò—â—É "):
            self._play_file("154")
            return True
        
        # –ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ
        if "–ò—â—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ" in text:
            self._play_file("155")
            return True
        
        # –ó–∞–ø—É—Å–∫–∞—é X (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ)
        if text.startswith("–ó–∞–ø—É—Å–∫–∞—é "):
            app_name = text.replace("–ó–∞–ø—É—Å–∫–∞—é ", "").lower()
            app_map = {
                "–¥–∏—Å–∫–æ—Ä–¥": "045", "discord": "045",
                "—Å—Ç–∏–º": "046", "steam": "046",
                "—Å–ø–æ—Ç–∏—Ñ–∞–π": "047", "spotify": "047",
                "—Ç–µ–ª–µ–≥—Ä–∞–º": "048", "telegram": "048",
                "–±–ª–æ–∫–Ω–æ—Ç": "049", "notepad": "049",
                "–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä": "050", "calculator": "050",
            }
            if app_name in app_map:
                self._play_file(app_map[app_name])
                return True
        
        # –û—Ç–∫—Ä—ã–≤–∞—é X (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ)
        if text.startswith("–û—Ç–∫—Ä—ã–≤–∞—é "):
            site_name = text.replace("–û—Ç–∫—Ä—ã–≤–∞—é ", "").lower()
            site_map = {
                "youtube": "038", "—é—Ç—É–±": "038",
                "chatgpt": "039", "—á–∞—Ç–≥–ø—Ç": "039",
                "google": "040", "–≥—É–≥–ª": "040",
                "–±—Ä–∞—É–∑–µ—Ä": "041",
                "–¥–∏—Å–ø–µ—Ç—á–µ—Ä –∑–∞–¥–∞—á": "042",
                "–ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è": "043",
                "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ windows": "044",
                "–ø—Ä–æ–≤–æ–¥–Ω–∏–∫": "059",
                "—Ä–∞–±–æ—á–∏–π —Å—Ç–æ–ª": "060",
                "–∑–∞–≥—Ä—É–∑–∫–∏": "061",
                "–¥–æ–∫—É–º–µ–Ω—Ç—ã": "062",
                "–ø–µ—Ä–µ–≤–æ–¥—á–∏–∫": "067",
                "–≤–∫–æ–Ω—Ç–∞–∫—Ç–µ": "068", "–≤–∫": "068",
                "–∏–Ω—Å—Ç–∞–≥—Ä–∞–º": "069", "instagram": "069",
                "—Ç–≤–∏—Ç—Ç–µ—Ä": "070", "twitter": "070",
                "—Ñ–µ–π—Å–±—É–∫": "071", "facebook": "071",
                "–≥–∏—Ç—Ö–∞–±": "072", "github": "072",
                "—Ç–≤–∏—á": "073", "twitch": "073",
                "–Ω–æ–≤–æ—Å—Ç–∏": "074",
                "–ø–æ—á—Ç—É": "075", "–ø–æ—á—Ç–∞": "075",
                "—è–Ω–¥–µ–∫—Å": "076",
                "–∫–∏–Ω–æ–ø–æ–∏—Å–∫": "077",
                "–≤–∏–∫–∏–ø–µ–¥–∏—é": "078", "–≤–∏–∫–∏–ø–µ–¥–∏—è": "078",
                "–Ω–µ—Ç—Ñ–ª–∏–∫—Å": "079", "netflix": "079",
            }
            if site_name in site_map:
                self._play_file(site_map[site_name])
                return True
        
        return False
    
    def _speak_fallback(self, text):
        """–ó–∞–ø–∞—Å–Ω–æ–π —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä —Ä–µ—á–∏"""
        if self.fallback_engine:
            try:
                self.fallback_engine.say(text)
                self.fallback_engine.runAndWait()
            except:
                print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–∑–≤—É—á–∏—Ç—å: {text}")
        else:
            print(f"‚ö†Ô∏è –ù–µ—Ç —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ –¥–ª—è: {text}")


if __name__ == "__main__":
    tts = TextToSpeech()
    tts.speak("–ü—Ä–∏–≤–µ—Ç! –Ø –î–∂–∞—Ä–≤–∏—Å, –∫ –≤–∞—à–∏–º —É—Å–ª—É–≥–∞–º.")
    tts.speak("–ì—Ä–æ–º–∫–æ—Å—Ç—å 50 –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤")
    tts.speak("–°–µ–π—á–∞—Å 15 —á–∞—Å–æ–≤ 30 –º–∏–Ω—É—Ç")
